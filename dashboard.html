<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‚Äî Quiz Gra√ßa Di√°ria</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#4A90E2" />

  <!-- Google AdSense (mant√©m, n√£o abrir√° an√∫ncios se precisar review) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2972396095728302" crossorigin="anonymous"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg1: #0f172a;
      --bg2: #1f2a44;
      --card: #ffffff;
      --accent1: #667eea;
      --accent2: #764ba2;
      --muted: #6b7280;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(135deg,var(--bg1) 0%, var(--bg2) 100%);
      color:#0b1220;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto}
    header.top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));
      padding:18px;
      border-radius:14px;
      box-shadow:0 6px 30px rgba(2,6,23,0.35);
      margin-bottom:20px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:center;gap:14px;
    }
    .logo{
      width:56px;height:56px;border-radius:12px;
      background:linear-gradient(135deg,var(--accent1),var(--accent2));
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px;
      box-shadow:0 6px 18px rgba(102,126,234,0.24);
    }
    .title h1{font-size:20px;margin:0;color:#0b1220}
    .title p{margin:0;color:var(--muted);font-size:13px}

    .user-controls{display:flex;align-items:center;gap:12px}
    .avatar{
      width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#9b8bf7,#6ea8f7);
      color:white;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:20px;
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
    }
    .user-info{display:flex;flex-direction:column;text-align:right}
    .user-info .name{font-weight:700;color:#0b1220}
    .user-info .email{font-size:13px;color:var(--muted)}

    .btn-logout{
      background:transparent;border:2px solid rgba(11,18,32,0.06);padding:10px 14px;border-radius:10px;cursor:pointer;
      font-weight:600;color:#0b1220;margin-left:8px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:18px;
      margin-bottom:18px;
    }
    @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){ .grid{grid-template-columns:1fr} .user-info{text-align:left} .user-controls{justify-content:flex-end} }

    .card{
      background:var(--card);
      border-radius:12px;
      padding:18px;
      box-shadow:0 10px 30px rgba(2,6,23,0.18);
      display:flex;flex-direction:column;gap:12px;
    }
    .kpi{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .kpi .left{display:flex;gap:12px;align-items:center}
    .kpi .icon{width:52px;height:52px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;color:white;background:linear-gradient(135deg,var(--accent1),var(--accent2));box-shadow:0 8px 22px rgba(102,126,234,0.18)}
    .kpi .value{font-size:24px;font-weight:800;color:#0b1220}
    .kpi .label{color:var(--muted);font-size:13px}

    .section{margin-bottom:18px}
    .section h3{margin:0 0 12px 0;font-size:16px;color:#0b1220}

    .achievements-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
    .achievement{padding:14px;border-radius:10px;background:#f7f9fc;text-align:center}
    .achievement.unlocked{background:linear-gradient(135deg,#e6eefc,#e7dcff);font-weight:700;color:#0b1220}

    .history-table{width:100%;border-collapse:collapse}
    .history-table th,.history-table td{padding:12px;border-bottom:1px solid #f1f5f9;text-align:left;font-size:14px;color:#0b1220}
    .history-table th{background:transparent;color:var(--muted);font-weight:700}

    .ad-container{display:flex;align-items:center;justify-content:center;padding:14px;border-radius:12px;background:linear-gradient(180deg,white, #fbfcff);min-height:90px}

    .loading-screen{display:flex;align-items:center;justify-content:center;min-height:240px;color:white;font-size:18px}
    .footer{margin-top:18px;text-align:center;color:#e6e9ef;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top" role="banner">
      <div class="brand">
        <div class="logo">GQ</div>
        <div class="title">
          <h1>Quiz ‚Äî Gra√ßa Di√°ria</h1>
          <p>Seu painel de progresso e estat√≠sticas</p>
        </div>
      </div>

      <div class="user-controls" role="navigation" aria-label="User controls">
        <div class="avatar" id="userAvatar">?</div>
        <div class="user-info">
          <div class="name" id="userName">Carregando...</div>
          <div class="email" id="userEmail">...</div>
        </div>
        <button id="logoutBtn" class="btn-logout" onclick="logout()">Sair</button>
      </div>
    </header>

    <div id="loading" class="loading-screen">‚è≥ Carregando seu dashboard...</div>

    <main id="dashboard" style="display:none">
      <div class="grid" aria-live="polite">
        <div class="card">
          <div class="kpi">
            <div class="left">
              <div class="icon">üéØ</div>
              <div>
                <div class="value" id="totalQuizzes">0</div>
                <div class="label">Quizzes realizados</div>
              </div>
            </div>
            <div style="text-align:right;color:var(--muted);font-size:12px">√öltimos 30 dias</div>
          </div>
        </div>

        <div class="card">
          <div class="kpi">
            <div class="left">
              <div class="icon">‚≠ê</div>
              <div>
                <div class="value" id="totalPoints">0</div>
                <div class="label">Pontos totais</div>
              </div>
            </div>
            <div style="text-align:right;color:var(--muted);font-size:12px">Acumulado</div>
          </div>
        </div>

        <div class="card">
          <div class="kpi">
            <div class="left">
              <div class="icon">üìà</div>
              <div>
                <div class="value" id="avgScore">0%</div>
                <div class="label">M√©dia de acertos</div>
              </div>
            </div>
            <div style="text-align:right;color:var(--muted);font-size:12px">Performance</div>
          </div>
        </div>
      </div>

      <div class="grid" style="grid-template-columns:2fr 1fr;">
        <div class="card">
          <div class="section">
            <h3>üìà Pontua√ß√£o ‚Äî √∫ltimos quizzes</h3>
            <canvas id="statsChart" width="800" height="300" aria-label="Gr√°fico de pontua√ß√£o"></canvas>
          </div>

          <div class="section">
            <h3>üìú Hist√≥rico de quizzes</h3>
            <div style="overflow:auto">
              <table class="history-table" aria-labelledby="history">
                <thead>
                  <tr><th>Data</th><th>Quiz</th><th>Pontua√ß√£o</th></tr>
                </thead>
                <tbody id="historyBody">
                  <tr><td colspan="3" style="text-align:center;color:var(--muted)">Nenhum quiz realizado ainda</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <aside>
          <div class="card" style="margin-bottom:12px">
            <h3>üèÜ Conquistas</h3>
            <div class="achievements-grid" id="achievementsGrid">
              <!-- preenchido dinamicamente -->
            </div>
          </div>

          <div class="card ad-container" id="adContainer" aria-hidden="true">
            <!-- AdSense slot -->
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-2972396095728302"
                 data-ad-slot="1234567890"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          </div>
        </aside>
      </div>

      <div class="footer">Se precisar, entre em contato: contato@seudominio.com</div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

    (async function initDashboard(){
      // === CONFIGURE AQUI: substitua pelos valores do seu projeto ===
      const firebaseConfig = {
        apiKey: "AIzaSyBqBXCUJKKZqJqJqJqJqJqJqJqJqJqJqJq",
        authDomain: "quiz-graca-diaria.firebaseapp.com",
        databaseURL: "https://quiz-graca-diaria-default-rtdb.firebaseio.com",
        projectId: "quiz-graca-diaria",
        storageBucket: "quiz-graca-diaria.appspot.com",
        messagingSenderId: "123456789012",
        appId: "1:123456789012:web:abcdef1234567890abcdef"
      };
      // ============================================================

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);

      console.log('üî• Firebase inicializado no dashboard', app.options);

      // Tenta garantir persist√™ncia local (se dispon√≠vel)
      try {
        await setPersistence(auth, browserLocalPersistence);
        console.log('‚úÖ Persist√™ncia definida: browserLocalPersistence');
      } catch (e) {
        console.warn('‚ö†Ô∏è Persist√™ncia n√£o aplicada (pode j√° estar definida):', e);
      }

      // Achievements padr√£o
      const allAchievements = [
        { id: 'first_quiz', name: 'Primeiro Passo', icon: 'üéØ', desc: 'Complete seu primeiro quiz' },
        { id: 'quiz_master', name: 'Mestre', icon: 'üèÜ', desc: 'Complete 10 quizzes' },
        { id: 'perfect_score', name: 'Perfei√ß√£o', icon: 'üíØ', desc: '100% em um quiz' },
        { id: 'dedicated', name: 'Dedicado', icon: '‚≠ê', desc: 'Complete 5 quizzes' },
        { id: 'scholar', name: 'Estudioso', icon: 'üìö', desc: 'Alcance 500 pontos' }
      ];

      // waitForAuth: tenta recuperar auth.currentUser por um per√≠odo
      async function waitForAuth(maxMs = 4000, interval = 250){
        const start = Date.now();
        while(Date.now() - start < maxMs){
          if(auth.currentUser) return auth.currentUser;
          await new Promise(r => setTimeout(r, interval));
        }
        return null;
      }

      // Registra listener
      onAuthStateChanged(auth, async (user) => {
        console.log('üîî onAuthStateChanged ->', user ? user.email : null);
        if(user){
          // usu√°rio autenticado
          await loadDashboard(user);
        } else {
          // tenta esperar um pouco se o SDK estiver restaurando a sess√£o
          const maybe = await waitForAuth(3500, 300);
          if(maybe) {
            await loadDashboard(maybe);
          } else {
            // n√£o redirecionar de imediato ‚Äî mostra mensagem e instru√ß√µes
            console.warn('‚ö†Ô∏è Usu√°rio n√£o autenticado ‚Äî redirecionando ao login em 1.5s se persistir');
            setTimeout(() => {
              if(!auth.currentUser) window.location.href = 'index.html';
            }, 1500);
          }
        }
      });

      // Se currentUser j√° estiver dispon√≠vel: carrega imediatamente
      if(auth.currentUser){
        console.log('‚ÑπÔ∏è auth.currentUser dispon√≠vel:', auth.currentUser.email);
        await loadDashboard(auth.currentUser);
      } else {
        console.log('‚ÑπÔ∏è auth.currentUser ainda null ‚Äî aguardando onAuthStateChanged...');
      }

      async function loadDashboard(user){
        try{
          console.log('‚û°Ô∏è Carregando dashboard para', user.uid, user.email);

          // preenche cabe√ßalho
          const displayName = user.displayName || user.email.split('@')[0];
          document.getElementById('userName').textContent = displayName;
          document.getElementById('userEmail').textContent = user.email;
          document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();

          // busca dados no Realtime Database
          const userRef = ref(db, `users/${user.uid}`);
          let snapshot;
          try {
            snapshot = await get(userRef);
          } catch(dbErr) {
            console.error('‚ùå Erro ao acessar Realtime DB:', dbErr);
            alert('Erro ao carregar dados do usu√°rio. Verifique as regras do Firebase.');
            return;
          }

          let userData;
          if(!snapshot.exists()){
            userData = { quizzes: [], totalPoints: 0, achievements: [] };
            try { await set(userRef, userData); } catch(e){ console.warn('‚ö†Ô∏è N√£o foi poss√≠vel criar perfil inicial:', e); }
          } else {
            userData = snapshot.val();
          }

          // popula UI
          populateStats(userData);
          populateHistory(userData.quizzes || []);
          populateAchievements(userData.achievements || []);

          // exibe dashboard (esconde loading)
          document.getElementById('loading').style.display = 'none';
          document.getElementById('dashboard').style.display = 'block';

          // inicializa AdSense com verifica√ß√£o de dimens√£o para evitar erro "slot size 0"
          setTimeout(() => {
            try {
              const adEl = document.getElementById('adContainer');
              const r = adEl.getBoundingClientRect();
              if(r.width > 0 && r.height > 0) {
                (adsbygoogle = window.adsbygoogle || []).push({});
                console.log('‚úÖ AdSense push executado');
              } else {
                console.warn('‚ö†Ô∏è Ad container com dimens√£o 0 ‚Äî AdSense n√£o inicializado agora.');
              }
            } catch(e) {
              console.warn('‚ö†Ô∏è Erro ao inicializar AdSense:', e);
            }
          }, 700);

        } catch(err){
          console.error('‚ùå loadDashboard erro:', err);
          alert('Ocorreu um erro ao carregar o dashboard.');
        }
      }

      function populateStats(userData){
        const quizzes = userData.quizzes || [];
        const totalQuizzes = quizzes.length;
        const totalPoints = userData.totalPoints || 0;
        const avgScore = totalQuizzes > 0 ? Math.round(quizzes.reduce((s,q)=>s+(q.score||0),0)/totalQuizzes) : 0;

        document.getElementById('totalQuizzes').textContent = totalQuizzes;
        document.getElementById('totalPoints').textContent = totalPoints;
        document.getElementById('avgScore').textContent = avgScore + '%';
        // inicializa gr√°fico com os √∫ltimos 10
        initChart(quizzes.slice(-10));
      }

      function populateHistory(quizzes){
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = '';
        if(!quizzes || quizzes.length === 0){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="3" style="text-align:center;color:#6b7280">Nenhum quiz realizado ainda</td>';
          tbody.appendChild(tr);
          return;
        }
        quizzes.slice(-10).reverse().forEach(q=>{
          const tr = document.createElement('tr');
          const date = q.date ? new Date(q.date).toLocaleString() : '-';
          tr.innerHTML = `<td>${date}</td><td>${escapeHtml(q.quizName||'Quiz')}</td><td>${q.score||0}%</td>`;
          tbody.appendChild(tr);
        });
      }

      function populateAchievements(achArr){
        const grid = document.getElementById('achievementsGrid');
        grid.innerHTML = '';
        allAchievements.forEach(a=>{
          const div = document.createElement('div');
          const unlocked = (achArr || []).includes(a.id);
          div.className = unlocked ? 'achievement unlocked' : 'achievement';
          div.innerHTML = `<div style="font-size:20px">${a.icon}</div><div style="margin-top:8px;font-weight:600">${escapeHtml(a.name)}</div><div style="font-size:12px;color:var(--muted)">${escapeHtml(a.desc)}</div>`;
          grid.appendChild(div);
        });
      }

      // gr√°fico
      let _chart = null;
      function initChart(data){
        const ctx = document.getElementById('statsChart').getContext('2d');
        const labels = data.map(d => d.date ? new Date(d.date).toLocaleDateString() : '');
        const scores = data.map(d => d.score || 0);
        if(_chart) _chart.destroy();
        _chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Pontua√ß√£o (%)',
              data: scores,
              backgroundColor: 'rgba(102,126,234,0.08)',
              borderColor: '#667eea',
              pointBackgroundColor: '#fff',
              tension: 0.25,
              pointRadius: 4,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero:true, suggestedMax:100 } }
          }
        });
      }

      // pequenas helpers
      function escapeHtml(s){
        if(typeof s !== 'string') return s;
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
      }

      // logout
      window.logout = async function(){
        try {
          await signOut(auth);
          window.location.href = 'index.html';
        } catch(e){
          console.error('Erro ao deslogar:', e);
          alert('Erro ao deslogar: ' + (e.message || e));
        }
      };

    })(); // fim initDashboard
  </script>
</body>
</html>
