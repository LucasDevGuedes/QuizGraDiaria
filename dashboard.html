<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Quiz B√≠blico</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4A90E2">

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2972396095728302"
     crossorigin="anonymous"></script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .user-details h2 {
            color: #333;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .user-details p {
            color: #666;
            font-size: 14px;
        }

        .logout-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform 0.3s;
        }

        .logout-btn:hover {
            transform: scale(1.05);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 16px;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .section h3 {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }

        .achievement {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .achievement.unlocked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .achievement.locked {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .achievement-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .achievement-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .achievement-desc {
            font-size: 12px;
            opacity: 0.8;
        }

        .quiz-history {
            overflow-x: auto;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th,
        .history-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .history-table th {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        .back-btn {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: bold;
            transition: transform 0.3s;
            margin-top: 20px;
        }

        .back-btn:hover {
            transform: scale(1.05);
        }

        /* AdSense Container */
        .ad-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
            min-height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 24px;
        }

        @media (max-width: 768px) {
            header {
                flex-direction: column;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .achievements-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="loading" id="loading">
            ‚è≥ Carregando seu dashboard...
        </div>

        <div id="dashboardContent" style="display: none;">
            <header>
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <div class="user-details">
                        <h2 id="userName">Carregando...</h2>
                        <p id="userEmail">...</p>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">üö™ Sair</button>
            </header>

            <!-- AdSense Banner -->
            <div class="ad-container">
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-2972396095728302"
                     data-ad-slot="1234567890"
                     data-ad-format="auto"
                     data-full-width-responsive="true"></ins>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-value" id="totalQuizzes">0</div>
                    <div class="stat-label">Quizzes Realizados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-value" id="totalPoints">0</div>
                    <div class="stat-label">Pontos Totais</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="avgScore">0%</div>
                    <div class="stat-label">M√©dia de Acertos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-value" id="achievements">0</div>
                    <div class="stat-label">Conquistas</div>
                </div>
            </div>

            <div class="section">
                <h3>üèÜ Suas Conquistas</h3>
                <div class="achievements-grid" id="achievementsGrid">
                    <!-- Conquistas ser√£o carregadas aqui -->
                </div>
            </div>

            <div class="section">
                <h3>üìú Hist√≥rico de Quizzes</h3>
                <div class="quiz-history">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Quiz</th>
                                <th>Pontua√ß√£o</th>
                                <th>Acertos</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 30px;">
                                    Nenhum quiz realizado ainda. Comece agora!
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div style="text-align: center;">
                <a href="index.html" class="back-btn">üè† Voltar ao In√≠cio</a>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBqBXCUJKKZqJqJqJqJqJqJqJqJqJqJqJq",
            authDomain: "quiz-graca-diaria.firebaseapp.com",
            databaseURL: "https://quiz-graca-diaria-default-rtdb.firebaseio.com",
            projectId: "quiz-graca-diaria",
            storageBucket: "quiz-graca-diaria.firebasestorage.app",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        console.log('üî• Firebase inicializado no dashboard');

        // Definir conquistas
        const allAchievements = [
            { id: 'first_quiz', icon: 'üéØ', name: 'Primeiro Passo', desc: 'Complete seu primeiro quiz' },
            { id: 'quiz_master', icon: 'üèÜ', name: 'Mestre dos Quizzes', desc: 'Complete 10 quizzes' },
            { id: 'perfect_score', icon: 'üíØ', name: 'Perfei√ß√£o', desc: 'Acerte 100% em um quiz' },
            { id: 'dedicated', icon: '‚≠ê', name: 'Dedicado', desc: 'Complete 5 quizzes' },
            { id: 'scholar', icon: 'üìö', name: 'Estudioso', desc: 'Alcance 500 pontos' },
            { id: 'expert', icon: 'üéì', name: 'Expert', desc: 'Alcance 1000 pontos' }
        ];

        onAuthStateChanged(auth, async (user) => {
            console.log('üîç onAuthStateChanged disparado');

            if (user) {
                console.log('‚úÖ Usu√°rio autenticado:', user.email);
                await loadDashboard(user);
            } else {
                console.log('‚ùå Nenhum usu√°rio autenticado');
                window.location.href = 'index.html';
            }
        });

        async function loadDashboard(user) {
            try {
                console.log('üì° Carregando dados do usu√°rio:', user.uid);

                // Atualizar informa√ß√µes do usu√°rio
                const userName = user.displayName || user.email.split('@')[0];
                const userInitial = userName.charAt(0).toUpperCase();

                document.getElementById('userName').textContent = userName;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userAvatar').textContent = userInitial;

                // Buscar dados do Firebase
                const userRef = ref(database, `users/${user.uid}`);
                const snapshot = await get(userRef);

                let userData = {
                    quizzes: [],
                    totalPoints: 0,
                    achievements: []
                };

                if (snapshot.exists()) {
                    userData = snapshot.val();
                    console.log('‚úÖ Dados carregados:', userData);
                } else {
                    console.log('‚ÑπÔ∏è Nenhum dado encontrado, criando perfil novo');
                    // Criar perfil inicial
                    await set(userRef, userData);
                }

                // Atualizar estat√≠sticas
                const quizzes = userData.quizzes || [];
                const totalQuizzes = quizzes.length;
                const totalPoints = userData.totalPoints || 0;
                const avgScore = totalQuizzes > 0 
                    ? Math.round(quizzes.reduce((sum, q) => sum + (q.score || 0), 0) / totalQuizzes)
                    : 0;

                document.getElementById('totalQuizzes').textContent = totalQuizzes;
                document.getElementById('totalPoints').textContent = totalPoints;
                document.getElementById('avgScore').textContent = avgScore + '%';
                document.getElementById('achievements').textContent = (userData.achievements || []).length;

                // Carregar conquistas
                loadAchievements(userData);

                // Carregar hist√≥rico
                loadHistory(quizzes);

                // Mostrar dashboard
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';

                // Inicializar AdSense ap√≥s o conte√∫do estar vis√≠vel
                setTimeout(() => {
                    try {
                        (adsbygoogle = window.adsbygoogle || []).push({});
                        console.log('‚úÖ AdSense inicializado');
                    } catch (e) {
                        console.log('‚ö†Ô∏è AdSense n√£o carregado:', e);
                    }
                }, 500);

            } catch (error) {
                console.error('‚ùå Erro ao carregar dashboard:', error);
                alert('Erro ao carregar dados. Verifique as regras do Firebase.');
            }
        }

        function loadAchievements(userData) {
            const userAchievements = userData.achievements || [];
            const grid = document.getElementById('achievementsGrid');
            grid.innerHTML = '';

            allAchievements.forEach(achievement => {
                const isUnlocked = userAchievements.includes(achievement.id);
                const div = document.createElement('div');
                div.className = `achievement ${isUnlocked ? 'unlocked' : 'locked'}`;
                div.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                `;
                grid.appendChild(div);
            });
        }

        function loadHistory(quizzes) {
            const tbody = document.getElementById('historyBody');

            if (!quizzes || quizzes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px;">
                            Nenhum quiz realizado ainda. <a href="index.html">Comece agora!</a>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            quizzes.slice(-10).reverse().forEach(quiz => {
                const tr = document.createElement('tr');
                const date = new Date(quiz.date).toLocaleDateString('pt-BR');
                tr.innerHTML = `
                    <td>${date}</td>
                    <td>${quiz.quizName || 'Quiz B√≠blico'}</td>
                    <td>${quiz.points || 0} pts</td>
                    <td>${quiz.score || 0}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.logout = async function() {
            if (confirm('Deseja realmente sair?')) {
                try {
                    await signOut(auth);
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('Erro ao sair:', error);
                    alert('Erro ao sair. Tente novamente.');
                }
            }
        };
    </script>
</body>
</html>
