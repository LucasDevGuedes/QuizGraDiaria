<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Quiz B√≠blico</title>
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#4A90E2" />

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2972396095728302" crossorigin="anonymous"></script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        #dashboardContent { animation: fadeIn .8s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 15px rgba(255,255,255,0.3);
        }

        .logout-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: transform .25s;
        }

        .logout-btn:hover { transform: scale(1.05); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform .25s, box-shadow .25s;
        }

        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.25);
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 20px;
        }

        .achievement {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            background: #f1f1f1;
            transition: all .3s;
        }

        .achievement.unlocked {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .achievement.locked {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 24px;
        }
    </style>
</head>

<body>
    <div class="loading" id="loading">‚è≥ Carregando seu dashboard...</div>

    <div id="dashboardContent" style="display:none;">

        <header>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">?</div>
                <div class="user-details">
                    <h2 id="userName">...</h2>
                    <p id="userEmail">...</p>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()">üö™ Sair</button>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalQuizzes">0</div>
                <div>Quizzes Realizados</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalPoints">0</div>
                <div>Pontos Totais</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgScore">0%</div>
                <div>M√©dia de Acertos</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="achievementsCount">0</div>
                <div>Conquistas</div>
            </div>
        </div>

        <div class="section">
            <h3>üèÜ Suas Conquistas</h3>
            <div id="achievementsGrid" class="achievements-grid"></div>
        </div>

        <div class="section">
            <h3>üìà Evolu√ß√£o</h3>
            <canvas id="statsChart"></canvas>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBqBXCUJKKZqJqJqJqJqJqJq",
            authDomain: "quiz-graca-diaria.firebaseapp.com",
            databaseURL: "https://quiz-graca-diaria-default-rtdb.firebaseio.com",
            projectId: "quiz-graca-diaria",
            storageBucket: "quiz-graca-diaria.firebasestorage.app",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef1234567890"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        console.log("üî• Firebase conectado");

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }

            console.log("‚úÖ Usu√°rio logado:", user.email);
            loadDashboard(user);
        });

        async function loadDashboard(user) {
            const userRef = ref(db, `users/${user.uid}`);
            const snapshot = await get(userRef);

            const data = snapshot.exists()
                ? snapshot.val()
                : { quizzes: [], totalPoints: 0, achievements: [] };

            renderUser(user);
            renderStats(data);
            renderAchievements(data);
            renderChart(data.quizzes);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
        }

        function renderUser(user) {
            const name = user.displayName || user.email.split("@")[0];
            document.getElementById("userName").textContent = name;
            document.getElementById("userEmail").textContent = user.email;
            document.getElementById("userAvatar").textContent = name.charAt(0).toUpperCase();
        }

        function renderStats(data) {
            const quizzes = data.quizzes || [];
            const totalPoints = data.totalPoints || 0;
            const avgScore = quizzes.length > 0
                ? Math.round(quizzes.reduce((sum, q) => sum + (q.score || 0), 0) / quizzes.length)
                : 0;

            document.getElementById("totalQuizzes").textContent = quizzes.length;
            document.getElementById("totalPoints").textContent = totalPoints;
            document.getElementById("avgScore").textContent = avgScore + "%";
            document.getElementById("achievementsCount").textContent = (data.achievements || []).length;
        }

        function renderAchievements(data) {
            const allAchievements = [
                { id: 'first_quiz', icon: 'üéØ', name: 'Primeiro Passo', desc: 'Complete seu primeiro quiz' },
                { id: 'quiz_master', icon: 'üèÜ', name: 'Mestre', desc: '10 quizzes completos' },
                { id: 'perfect_score', icon: 'üíØ', name: 'Perfeito', desc: '100% em um quiz' },
                { id: 'dedicated', icon: '‚≠ê', name: 'Dedicado', desc: '5 quizzes completos' },
                { id: 'scholar', icon: 'üìö', name: 'Estudioso', desc: '500 pontos' }
            ];

            const unlocked = data.achievements || [];
            const grid = document.getElementById("achievementsGrid");

            grid.innerHTML = "";

            allAchievements.forEach(a => {
                const div = document.createElement("div");
                div.className = `achievement ${unlocked.includes(a.id) ? "unlocked" : "locked"}`;
                div.innerHTML = `
                    <div style="font-size:40px">${a.icon}</div>
                    <div><b>${a.name}</b></div>
                    <small>${a.desc}</small>
                `;
                grid.appendChild(div);
            });
        }

        function renderChart(quizzes) {
            const ctx = document.getElementById("statsChart");

            const labels = quizzes.slice(-10).map(q => new Date(q.date).toLocaleDateString("pt-BR"));
            const scores = quizzes.slice(-10).map(q => q.score || 0);

            new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Pontua√ß√£o",
                        data: scores,
                        borderColor: "#667eea",
                        fill: false,
                        tension: 0.2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { min: 0, max: 100 }
                    }
                }
            });
        }

        window.logout = async function () {
            await signOut(auth);
            window.location.href = "index.html";
        };
    </script>
</body>
</html>
